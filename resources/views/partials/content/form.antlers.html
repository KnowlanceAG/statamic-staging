{{ form:create in="{ form:handle }" id="form" class="flex flex-wrap form-self"
x-ref="form" x-data="sending()" data-submission-type="{ form:handle }"
@submit.prevent="sendForm()" action="javascript:void(0);"
 }}
  <div
    class="w-full grid md:grid-cols-12 gap-y-6 md:gap-x-6 pt-6 pb-12 px-2 sm:px-6 lg:pt-8 lg:pb-16 lg:px-8 bg-gray-200">
    {{# Honeypot spam protection. #}}
    <div class="hidden">
      <label class="block uppercase tracking-wide text-black text-xs mt-4 mb-1" for="fax">
        Fax
        <sup class="text-notice-400">*</sup>
      </label>
      <input class="form-input w-full" id="fax" type="fax" name="fax" tabindex="-1" autocomplete="off" />
    </div>

    {{ fields }}
      {{ if handle=='gw_source' }}
        <div class="hidden">
          {{ field }}
        </div>
      {{ else }}
        <div class="flex flex-col space-y-4
          {{ width == '25' ?= 'md:col-span-3' }}
          {{ width == '33' ?= 'md:col-span-4' }}
          {{ width == '50' ?= 'md:col-span-6' }}
          {{ width == '66' ?= 'md:col-span-8' }}
          {{ width == '75' ?= 'md:col-span-9' }}
          {{ width == '100' ?= 'md:col-span-12' }}">
          <label class="block uppercase tracking-wide text-black text-xs mt-4 mb-1"
            for="{{ handle }}">
            {{ trans key="{display}" }}
            {{ if validate | contains:required }}
              <sup class="text-red-500">*</sup>
            {{ /if }}
          </label>

          <div x-bind:class="{
                'border border-red-500' : errors.{{ handle }}
            }">
            {{ if tooltip }}
              <div class="has-tooltip relative">
                <span
                  class='tooltip rounded shadow-xl px-2 py-1 ml-14 border border-gray-300 text-xs leading-5 max-w-full w-auto bg-white text-black'>
                  {{ tooltip }}
                </span>
                {{ field }}
              </div>
            {{ else }}
              {{ field }}
            {{ /if }}

            {{ if instructions }}
              <p class="text-sm text-gray-700">
                {{ instructions | markdown }}
              </p>
            {{ /if }}
          </div>
          {{# Load notification when there is a validation error with the name field.
        #}}
          <template x-if="errors.{{ handle }}">
            {{ partial src="components/notification" type="error"
          attribute="x-text='clientTranslation(\"{handle}\", errors.{ handle })'"
          handle="{handle}" }}
          </template>
        </div>
      {{ /if }}
    {{ /fields }}

    <div class="my-4 md:col-span-12">
      {{ form_info_text }}
        {{ text }}
      {{ /form_info_text }}
    </div>

    <div class="md:col-span-12 flex">
      <button
        class="relative bg-orange-500 hover:bg-orange-700 px-10 py-3 mt-8 inline-block text-white font-300 uppercase rounded-sm hover:transition-colors hover:duration-200 hover:bg-opacity-95"
        type="submit">

        <span id="submit-button-text">
          {{ if form.handle == 'autorenbewerbung' }} Bewerbung absenden {{ elseif
            form.handle == 'anfrage' }}
            Anfrage absenden {{ else }}
            Absenden {{ /if }}
        </span>

        <span id="submit-button-spinner" class="opacity-0">
          <div class="spinner absolute left-0 right-0 top-4">
            <div class="bounce1"></div>
            <div class="bounce2"></div>
            <div class="bounce3"></div>
          </div>
        </span>

      </button>
    </div>
  </div>
{{ /form:create }}
<script>
  const actionUrl =
    "{{ config:cpssg:dynamic_site_url }}/!/forms/{{ form:handle }}"
  const tokenRoute = '/!/DynamicToken/refresh'
  const selector = 'form.form-self input[name="_token"]'
  const minutes = 15

  const formURL = new URL(actionUrl);
  const formOrigin = formURL.origin
  const tokenURL = formOrigin + tokenRoute;

  // Receive and refresh form token
  const hiddenInputs = document.querySelectorAll(selector);
  if (hiddenInputs.length) {
    function httpGetAsync(theUrl, callback) {
      const xmlHttp = new XMLHttpRequest();
      xmlHttp.onreadystatechange = function() {
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
          try {
            const token = JSON.parse(xmlHttp.responseText);
            callback((token || {}).csrf_token);
          } catch (err) {
            console.log('Error parsing token', err);
          }
      };
      xmlHttp.open('GET', theUrl, true); // true for asynchronous
      xmlHttp.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
      xmlHttp.send(null);
    }

    function setToken(token) {
      document
        .querySelectorAll(selector)
        .forEach(function(item) {
          item.value = token;
        });
    }

    function updateToken() {
      httpGetAsync(tokenURL, setToken);
    }
    updateToken();
    setInterval(updateToken, minutes * 60 * 1000);
  }

  function clientTranslation(name, preprocessed) {
    if (
      name === 'e_mail_adresse' &&
      preprocessed !== 'Bitte e mail adresse angeben.'
    ) {
      return preprocessed
    }

    if (
      ['file', 'datei_anhang', 'upload'].includes(name) &&
      preprocessed.startsWith('Muss eine Datei vom Typ')
    ) {
      return 'Folgende Dateiformate werden akzeptiert: jpg/jpeg, png, pdf, doc, docx, xls, xlsx, zip'
    }

    switch (name) {
      case 'e_mail_adresse':
        return 'Bitte eine E-Mail-Adresse angeben.'
      case 'fachrichtung':
        return 'Bitte die gewünschte Fachrichtung für die Anfrage auswählen.'
      case 'arbeitsthema_spezifikationen_usw':
        return 'Bitte eine Beschreibung für die Anfrage angeben.'
      case 'fachbereiche_and_interessensschwerpunkte':
        return 'Bitte Fachbereiche angeben.'
      case 'file':
        return 'Bitte laden Sie eine Datei hoch.'
    }
    return 'Bitte das Feld ausfüllen.'
  }

  function sending() {
    return {
      error: false,
      errors: [],
      sending: false,
      success: false,
      submitButtonText: null,
      submitButtonSpinner: null,
      toggleButtonSpinner() {
        if (this.submitButtonText) {
          this.submitButtonText.classList.toggle('opacity-0')
        }
        if (this.submitButtonSpinner) {
          this.submitButtonSpinner.classList.toggle('opacity-0')
        }
      },
      initButtonSpinner() {
        this.submitButtonText = form.querySelector('#submit-button-text')
        this.submitButtonSpinner = form.querySelector('#submit-button-spinner')
        this.toggleButtonSpinner()
      },
      sendForm() {
        this.sending = true
        const form = document.querySelector('.form-self')
        const route = '/!/cpssg/forms/'
        if (actionUrl) {
          this.initButtonSpinner()
          const formURL = new URL(actionUrl)
          const source = document.querySelector('[name="gw_source"]')

          // added affiliate as source
          const isIFrame = !(window === window.parent || window.opener)
          const sourceValue = isIFrame ? 'Affiliate' : window.location.hostname
          source.setAttribute('value', sourceValue)
          const formOrigin = formURL.origin
          const submissionURL = formOrigin + route + form.dataset.submissionType
          fetch(submissionURL, {
              headers: {
                'X-Requested-With': 'XMLHttpRequest',
              },
              method: 'POST',
              body: new FormData(this.$refs.form),
            })
            .then((res) => res.json())
            .then((json) => {
              if (json['success']) {
                this.toggleButtonSpinner()
                this.errors = []
                this.success = true
                this.error = false
                this.sending = false
                this.$refs.form.reset()
                window.location.assign('/anfrage-abgesendet')
              }
              if (json['error']) {
                this.toggleButtonSpinner()
                this.sending = false
                this.error = true
                this.success = false
                this.errors = json['error']
                form.scrollIntoView({
                  behavior: "smooth",
                  block: "start",
                  inline: "nearest"
                });
              }
            })
            .catch((err) => {
              this.toggleButtonSpinner()
              this.sending = false
              if (err && err.text) {
                err.text().then((errorMessage) => {
                  console.log('errorMessage', errorMessage)
                })
              }
            })
        }
      },
    }
  }
</script>
